---
title: "README"
author: "Isabelle Boulangeat"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  html_document:
    keep_md: yes
    variant: markdown_github
  pdf_document: default
editor_options:
  chunk_output_type: console
always_allow_html: yes
---

```{r setup, include=FALSE}
library(knitr)
# library(kableExtra)
knitr::opts_chunk$set(echo = TRUE)
# library(Jmisc)
library(tidyr)
sapply(list.files("R_fct"), function(x)source(paste0("R_fct/",x)))
require(sp)
require(dplyr)
require(ggplot2)
require(ggmap)
require(sf)
require(raster)
require(terra)
require(stars)
require(starsExtra)
require(shadow)
require(rgdal)
require(mapview)
```

# Données

## Données de présence de Erica Carnea
```{r visudata, echo = FALSE, fig = TRUE}
library(leaflet) 
library(leafem)
library(stars)
sites_all = read.csv("_data_prod/sites_all.csv")
rasalti = raster('_data_prod/DEM90_sa.tif')
staralti= read_stars("_data_prod/DEM90_sa.tif", proxy = FALSE,  package="stars")

rasaltiwm = raster('_data_prod/DEM90_sa_wo_merc.tif')
staraltiwm= read_stars("_data_prod/DEM90_sa_wo_merc.tif", proxy = FALSE,  package="stars")

leaflet(sites_all)%>%
  addProviderTiles("OpenStreetMap.HOT")%>%
  leafem::addGeoRaster(staralti, opacity = 0.6, colorOptions = colorOptions(palette = "Blues")) %>%
  setView(lng=5.5,lat=45,zoom=6) %>%
  leafem::addGeoRaster(staraltiwm, opacity = 0.6, colorOptions = colorOptions(palette = "Reds")) %>%
  setView(lng=5.5,lat=45,zoom=6) %>%
  addCircleMarkers(lng = ~lon_wgs84, lat = ~lat_wgs84, popup = ~date, radius = 0.3, opacity = 0.8, color = "black") 


```


## Variables explicatives pour le modèle de distributio
```{r varexpl}
# BIO1 = Annual Mean Temperature
# BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))
# BIO3 = Isothermality (BIO2/BIO7) (×100)
# BIO4 = Temperature Seasonality (standard deviation ×100)
# BIO5 = Max Temperature of Warmest Month
# BIO6 = Min Temperature of Coldest Month
# BIO12 = Annual Precipitation
# BIO15 = Precipitation Seasonality (Coefficient of Variation)
# gdd0 = heat sum of all days above the 0°C temperature accumulated over 1 year
# gsl = Length of the growing season (TREELIM)
# gsp = precipitation sum accumulated on all days during the growing season )TREELIM)
# gst = Mean temperature of all growing season days (TREELIM)
# ngd0 = Number of days at which tas > 0°C
# npp = Calculated based on the ‘Miami model’
# scd = Number of days with snowcover (TREELIM)

```


# Modèle de distribution

## Calibration
```{r rfmod, fig = TRUE}
library(randomForest)
set.seed(516)
tuneRF(x=dataset[,c(1:(ncol(dataset)-1))],y=as.factor(dataset$response))

rf.ericar<-randomForest(as.factor(response)~.,mtry=4,ntree=1000,data=dataset)

```

```{r rfspat}
rasalti = rast('ras_alti.tif')
library(spatialRF)
dependent.variable.name <- "response"
predictor.variable.names <- colnames(dataset)[-ncol(dataset)]
dataclean = dataset[which(complete.cases(dataset)),]

xy <- data.frame(rbind(
  coordinates(spTransform(data_env_topo_clim$obs , crs(rasalti))),
  coordinates(spTransform(data_env_topo_clim$bg , crs(rasalti)))
   )[which(complete.cases(dataset)),])
colnames(xy) = c("x", "y")
dim(xy)

dist.mat = dist(xy, diag=T, upper=T)

model.non.spatial <- spatialRF::rf(
  data = dataclean,
  dependent.variable.name = dependent.variable.name,
  predictor.variable.names = predictor.variable.names,
  distance.matrix = as.matrix(dist.mat),
  distance.thresholds = c(5000, 10000),
  xy = xy, 
  seed = 126,
  verbose = TRUE
)

```



```{r rfspat importance, fig = TRUE}


p1 <- spatialRF::plot_importance(
  model.non.spatial, 
  verbose = FALSE) + 
  ggplot2::ggtitle("Non-spatial model") 

# p2 <- spatialRF::plot_importance(
#   model.spatial,
#   verbose = FALSE) + 
#   ggplot2::ggtitle("Spatial model")
# 
# p1 | p2 

p1
```

```{r rfspat response, fig = TRUE}
spatialRF::plot_response_curves(
  model.spatial,
  variables = NULL,
  quantiles = 0.5,
  ncol = 3
)
```


## Prediction / projection
```{r predictorT, fig = TRUE, cache = TRUE}
topo_rast =  rast("_data/predRast_topo.grd")
clim_rast = rast("_data/predRast_clim.grd")
topo_clip = crop(topo_rast, clim_rast)
rast_envtopo <- c(topo_clip, clim_rast)
plot(rast_envtopo)
# rf.predict.ericar <- predict(rast_envtopo, rf.ericar, type = "prob")
# writeRaster(rf.predict.ericar$X1, file = "rf.predict.ericar.tif", overwrite=TRUE)

```

```{r predict, fig = TRUE}
ras = raster("rf.predict.ericar.tif")
plot(ras)
bbox2 <- tmaptools::bb(xlim = c(6.10,  8.00), ylim = c(44, 46.1))
bbox2_proj = st_bbox(st_transform(st_as_sfc(bbox2), crs(ras)))
ras_crop = terra::crop(ras, extent(bbox2_proj))
 
rf.predict.ericar= read_stars("rf.predict.ericar.tif")
mapview::mapviewOptions(na.color = "transparent",
               basemaps="OpenStreetMap",
               viewer.suppress=TRUE,
               trim=TRUE)
mapview(ras_crop) +
  mapview(st_as_sf(sites_points1), legend = FALSE, cex = 5)
```

# Niche (plan ecologique)